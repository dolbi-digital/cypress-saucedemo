name: Cypress Multi-Browser + Allure Pages

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]
    name: Run on ${{ matrix.browser }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Cypress run (${{ matrix.browser }})
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          headed: false
          config-file: cypress.config.ts
        env:
          # Allure plugin writes results here
          ALLURE_RESULTS_DIR: allure-results

      - name: Upload Allure results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results
          if-no-files-found: error

      # Optional: upload screenshots/videos for debugging
      - name: Upload Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.browser }}
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Upload Videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ matrix.browser }}
          path: cypress/videos
          if-no-files-found: ignore

  merge-and-publish:
    name: Merge Allure & Publish to Pages
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - name: Checkout (default branch)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Allure CLI
        run: |
          npm i -D allure-commandline
          echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH

      - name: Download Allure results from all browsers
        uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          merge-multiple: true
          path: _allure_artifacts

      - name: Merge results into single folder
        run: |
          mkdir -p allure-results
          find _allure_artifacts -type f -print -exec cp {} allure-results/ \;

      # Pull previous history from gh-pages (if it exists)
      - name: Checkout gh-pages (for history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Restore previous history into results
        run: |
          if [ -d "gh-pages/allure-history" ]; then
            mkdir -p allure-results/history
            cp -r gh-pages/allure-history/* allure-results/history/ || true
          fi

      - name: Generate Allure report
        run: |
          allure generate allure-results --clean -o allure-report

      # Prepare single publish dir that includes the report and a copy of history
      - name: Prepare publish directory
        run: |
          mkdir -p public
          cp -r allure-report/* public/
          mkdir -p public/allure-history
          cp -r allure-report/history/* public/allure-history/ || true

      - name: Publish to GitHub Pages (single deploy)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: public
          keep_files: true
