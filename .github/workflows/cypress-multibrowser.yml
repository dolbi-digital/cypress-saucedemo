name: Cypress Multi-Browser + Allure Pages

on:
  push:
    branches: [ main ]
  pull_request:

permissions:
  contents: write    # needed to push to gh-pages
  actions: read

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]
    name: Run on ${{ matrix.browser }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Cypress run (${{ matrix.browser }})
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          headed: false
          # If your config file is TS:
          config-file: cypress.config.ts
        env:
          # ensure Allure plugin writes results
          ALLURE_RESULTS_DIR: allure-results

      - name: Upload Allure results
        if: always()                       # upload even on test failures
        uses: actions/upload-artifact@v4
        with:
          name: allure-results-${{ matrix.browser }}
          path: allure-results
          if-no-files-found: error

  merge-and-publish:
    name: Merge Allure & Publish to Pages
    runs-on: ubuntu-latest
    needs: [test]                          # wait for all browsers
    steps:
      - name: Checkout (default branch)
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Allure CLI
        run: |
          npm i -D allure-commandline
          echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH

      - name: Download Allure results from all browsers
        uses: actions/download-artifact@v4
        with:
          # download all artifacts that start with this pattern
          pattern: allure-results-*
          merge-multiple: true
          path: _allure_artifacts

      - name: Merge results into single folder
        run: |
          mkdir -p allure-results
          # copy all per-browser results into one folder
          find _allure_artifacts -type f -print -exec cp {} allure-results/ \;

      # Pull previous history from gh-pages (if it exists)
      - name: Checkout gh-pages (for history)
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Restore history
        run: |
          if [ -d "gh-pages/allure-history" ]; then
            mkdir -p allure-results/history
            cp -r gh-pages/allure-history/* allure-results/history/ || true
          fi

      - name: Generate Allure report
        run: |
          allure generate allure-results --clean -o allure-report
          # save history for next runs
          mkdir -p allure-report/history
          cp -r allure-report/history ./allure-history || true

      - name: Publish Allure to gh-pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report
          keep_files: true

      - name: Save history folder on gh-pages root (for next run)
        run: |
          # We also publish /allure-history alongside the report
          # so next pipeline can fetch it before generation.
          mkdir -p push-history/allure-history
          cp -r allure-report/history push-history/allure-history
        shell: bash

      - name: Push history folder
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: push-history
          destination_dir: .
          keep_files: true
